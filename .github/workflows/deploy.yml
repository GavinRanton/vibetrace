name: Deploy to Production

on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Build Next.js Standalone App
        run: npm run build

      - name: Prepare Standalone Directory
        run: |
          mkdir -p .next/standalone/.next
          cp -r .next/static .next/standalone/.next/static
          [ -d public ] && cp -r public .next/standalone/public || true

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}

      - name: Deploy to VPS
        env:
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          set -e
          RELEASE_TS=$(date +%Y%m%d%H%M%S)
          RELEASE_DIR="/home/ralph/releases/${REPO_NAME}-${RELEASE_TS}"
          LIVE_DIR="/home/ralph/${REPO_NAME}"

          echo "Adding VPS to known hosts..."
          ssh-keyscan -H 157.180.32.69 >> ~/.ssh/known_hosts

          echo "Creating release directory: $RELEASE_DIR"
          ssh ralph@157.180.32.69 "mkdir -p $RELEASE_DIR"

          echo "Syncing build (excluding start.sh and .env)..."
          rsync -az --delete \
            --exclude='start.sh' \
            --exclude='.env' \
            .next/standalone/ ralph@157.180.32.69:$RELEASE_DIR/

          echo "Updating symlink..."
          ssh ralph@157.180.32.69 "ln -snf $RELEASE_DIR $LIVE_DIR"

          echo "Restarting PM2..."
          ssh ralph@157.180.32.69 "pm2 restart $REPO_NAME"

      - name: Notify on Success
        if: success()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "✅ Deployed ${{ github.event.repository.name }} to production successfully."

      - name: Notify on Failure
        if: failure()
        uses: appleboy/telegram-action@master
        with:
          to: ${{ secrets.TELEGRAM_TO }}
          token: ${{ secrets.TELEGRAM_TOKEN }}
          message: "❌ Deploy failed for ${{ github.event.repository.name }}. Check GitHub Actions."
